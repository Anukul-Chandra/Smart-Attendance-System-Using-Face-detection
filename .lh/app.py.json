{
    "sourceFile": "app.py",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 4,
            "patches": [
                {
                    "date": 1766770193496,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1766770363906,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,8 @@\n from fastapi import FastAPI, UploadFile, File\n import shutil\n import os\n+from face_utils import recognize_face\n \n app = FastAPI(title=\"Smart Attendance API\")\n \n UPLOAD_DIR = \"uploads\"\n@@ -11,14 +12,15 @@\n def root():\n     return {\"message\": \"Smart Attendance API is running\"}\n \n @app.post(\"/recognize\")\n-async def recognize_face(file: UploadFile = File(...)):\n-    file_path = os.path.join(UPLOAD_DIR, file.filename)\n+async def recognize(file: UploadFile = File(...)):\n+    image_path = f\"{UPLOAD_DIR}/{file.filename}\"\n \n-    with open(file_path, \"wb\") as buffer:\n+    with open(image_path, \"wb\") as buffer:\n         shutil.copyfileobj(file.file, buffer)\n \n+    name = recognize_face(image_path)\n+\n     return {\n-        \"status\": \"received\",\n-        \"filename\": file.filename\n+        \"recognized_person\": name\n     }\n"
                },
                {
                    "date": 1766772302627,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,26 +1,35 @@\n from fastapi import FastAPI, UploadFile, File\n import shutil\n import os\n+import uuid\n+\n from face_utils import recognize_face\n \n app = FastAPI(title=\"Smart Attendance API\")\n \n-UPLOAD_DIR = \"uploads\"\n+UPLOAD_DIR = \"temp_uploads\"\n os.makedirs(UPLOAD_DIR, exist_ok=True)\n \n+# ---------------- ROOT ----------------\n @app.get(\"/\")\n def root():\n     return {\"message\": \"Smart Attendance API is running\"}\n \n+# ---------------- RECOGNIZE ----------------\n @app.post(\"/recognize\")\n async def recognize(file: UploadFile = File(...)):\n-    image_path = f\"{UPLOAD_DIR}/{file.filename}\"\n+    # save uploaded image\n+    file_ext = file.filename.split(\".\")[-1]\n+    temp_filename = f\"{uuid.uuid4()}.{file_ext}\"\n+    temp_path = os.path.join(UPLOAD_DIR, temp_filename)\n \n-    with open(image_path, \"wb\") as buffer:\n+    with open(temp_path, \"wb\") as buffer:\n         shutil.copyfileobj(file.file, buffer)\n \n-    name = recognize_face(image_path)\n+    # recognize\n+    result = recognize_face(temp_path)\n \n-    return {\n-        \"recognized_person\": name\n-    }\n+    # cleanup\n+    os.remove(temp_path)\n+\n+    return result\n"
                },
                {
                    "date": 1766772755934,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,35 +1,71 @@\n-from fastapi import FastAPI, UploadFile, File\n-import shutil\n+import cv2\n import os\n-import uuid\n+import pickle\n+import numpy as np\n+from deepface import DeepFace\n \n-from face_utils import recognize_face\n+# ---------------- CONFIG ----------------\n+EMBEDDINGS_DIR = \"embeddings\"\n+MODEL_NAME = \"Facenet\"\n+DISTANCE_THRESHOLD = 0.55   # strict\n \n-app = FastAPI(title=\"Smart Attendance API\")\n+# ---------------- LOAD EMBEDDINGS ----------------\n+db = {}\n \n-UPLOAD_DIR = \"temp_uploads\"\n-os.makedirs(UPLOAD_DIR, exist_ok=True)\n+for file in os.listdir(EMBEDDINGS_DIR):\n+    if file.endswith(\".pkl\"):\n+        name = file.replace(\".pkl\", \"\")\n+        with open(os.path.join(EMBEDDINGS_DIR, file), \"rb\") as f:\n+            db[name] = pickle.load(f)\n \n-# ---------------- ROOT ----------------\n-@app.get(\"/\")\n-def root():\n-    return {\"message\": \"Smart Attendance API is running\"}\n+print(\"âœ… Loaded users:\", list(db.keys()))\n \n-# ---------------- RECOGNIZE ----------------\n-@app.post(\"/recognize\")\n-async def recognize(file: UploadFile = File(...)):\n-    # save uploaded image\n-    file_ext = file.filename.split(\".\")[-1]\n-    temp_filename = f\"{uuid.uuid4()}.{file_ext}\"\n-    temp_path = os.path.join(UPLOAD_DIR, temp_filename)\n+# ---------------- CAMERA ----------------\n+cap = cv2.VideoCapture(0)\n+print(\"ðŸ“· Camera started\")\n \n-    with open(temp_path, \"wb\") as buffer:\n-        shutil.copyfileobj(file.file, buffer)\n+while True:\n+    ret, frame = cap.read()\n+    if not ret:\n+        break\n \n-    # recognize\n-    result = recognize_face(temp_path)\n+    try:\n+        reps = DeepFace.represent(\n+            img_path=frame,\n+            model_name=MODEL_NAME,\n+            enforce_detection=True\n+        )\n+        live_emb = np.array(reps[0][\"embedding\"])\n+    except:\n+        cv2.imshow(\"Attendance\", frame)\n+        continue\n \n-    # cleanup\n-    os.remove(temp_path)\n+    identity = \"Unknown\"\n+    min_dist = 999\n \n-    return result\n+    for name, embeddings in db.items():\n+        for emb in embeddings:\n+            dist = np.linalg.norm(live_emb - emb)\n+            if dist < min_dist:\n+                min_dist = dist\n+                identity = name\n+\n+    print(\"DEBUG distance:\", min_dist)\n+\n+    if min_dist < DISTANCE_THRESHOLD:\n+        label = f\"{identity} âœ…\"\n+        color = (0, 255, 0)\n+    else:\n+        label = \"Unknown âŒ\"\n+        color = (0, 0, 255)\n+\n+    cv2.putText(frame, label, (20, 40),\n+                cv2.FONT_HERSHEY_SIMPLEX, 1, color, 2)\n+\n+    cv2.imshow(\"Attendance\", frame)\n+\n+    if cv2.waitKey(1) & 0xFF == 27:\n+        break\n+\n+cap.release()\n+cv2.destroyAllWindows()\n"
                },
                {
                    "date": 1766772761454,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,15 +1,23 @@\n+from fastapi import FastAPI, UploadFile, File\n+from fastapi.responses import JSONResponse\n import cv2\n+import numpy as np\n import os\n import pickle\n-import numpy as np\n+import tempfile\n from deepface import DeepFace\n \n # ---------------- CONFIG ----------------\n EMBEDDINGS_DIR = \"embeddings\"\n MODEL_NAME = \"Facenet\"\n-DISTANCE_THRESHOLD = 0.55   # strict\n+DISTANCE_THRESHOLD = 0.55   # strict threshold\n \n+app = FastAPI(\n+    title=\"Smart Attendance API\",\n+    version=\"1.0.0\"\n+)\n+\n # ---------------- LOAD EMBEDDINGS ----------------\n db = {}\n \n for file in os.listdir(EMBEDDINGS_DIR):\n@@ -19,53 +27,65 @@\n             db[name] = pickle.load(f)\n \n print(\"âœ… Loaded users:\", list(db.keys()))\n \n-# ---------------- CAMERA ----------------\n-cap = cv2.VideoCapture(0)\n-print(\"ðŸ“· Camera started\")\n+# ---------------- ROOT ----------------\n+@app.get(\"/\")\n+def root():\n+    return {\"message\": \"Smart Attendance API is running\"}\n \n-while True:\n-    ret, frame = cap.read()\n-    if not ret:\n-        break\n+# ---------------- RECOGNIZE API ----------------\n+@app.post(\"/recognize\")\n+async def recognize_face(file: UploadFile = File(...)):\n+    try:\n+        # Save uploaded image temporarily\n+        with tempfile.NamedTemporaryFile(delete=False, suffix=\".jpg\") as tmp:\n+            contents = await file.read()\n+            tmp.write(contents)\n+            img_path = tmp.name\n \n-    try:\n+        img = cv2.imread(img_path)\n+        if img is None:\n+            return JSONResponse(\n+                status_code=400,\n+                content={\"error\": \"Invalid image\"}\n+            )\n+\n+        # Face embedding\n         reps = DeepFace.represent(\n-            img_path=frame,\n+            img_path=img,\n             model_name=MODEL_NAME,\n             enforce_detection=True\n         )\n+\n         live_emb = np.array(reps[0][\"embedding\"])\n-    except:\n-        cv2.imshow(\"Attendance\", frame)\n-        continue\n \n-    identity = \"Unknown\"\n-    min_dist = 999\n+        identity = \"Unknown\"\n+        min_dist = 999\n \n-    for name, embeddings in db.items():\n-        for emb in embeddings:\n-            dist = np.linalg.norm(live_emb - emb)\n-            if dist < min_dist:\n-                min_dist = dist\n-                identity = name\n+        for name, embeddings in db.items():\n+            for emb in embeddings:\n+                dist = np.linalg.norm(live_emb - emb)\n+                if dist < min_dist:\n+                    min_dist = dist\n+                    identity = name\n \n-    print(\"DEBUG distance:\", min_dist)\n+        print(\"DEBUG distance:\", min_dist)\n \n-    if min_dist < DISTANCE_THRESHOLD:\n-        label = f\"{identity} âœ…\"\n-        color = (0, 255, 0)\n-    else:\n-        label = \"Unknown âŒ\"\n-        color = (0, 0, 255)\n+        if min_dist < DISTANCE_THRESHOLD:\n+            return {\n+                \"recognized_person\": identity,\n+                \"distance\": round(min_dist, 4),\n+                \"status\": \"matched\"\n+            }\n+        else:\n+            return {\n+                \"recognized_person\": \"Unknown\",\n+                \"distance\": round(min_dist, 4),\n+                \"status\": \"not_in_database\"\n+            }\n \n-    cv2.putText(frame, label, (20, 40),\n-                cv2.FONT_HERSHEY_SIMPLEX, 1, color, 2)\n-\n-    cv2.imshow(\"Attendance\", frame)\n-\n-    if cv2.waitKey(1) & 0xFF == 27:\n-        break\n-\n-cap.release()\n-cv2.destroyAllWindows()\n+    except Exception as e:\n+        return JSONResponse(\n+            status_code=500,\n+            content={\"error\": str(e)}\n+        )\n"
                }
            ],
            "date": 1766770193496,
            "name": "Commit-0",
            "content": "from fastapi import FastAPI, UploadFile, File\nimport shutil\nimport os\n\napp = FastAPI(title=\"Smart Attendance API\")\n\nUPLOAD_DIR = \"uploads\"\nos.makedirs(UPLOAD_DIR, exist_ok=True)\n\n@app.get(\"/\")\ndef root():\n    return {\"message\": \"Smart Attendance API is running\"}\n\n@app.post(\"/recognize\")\nasync def recognize_face(file: UploadFile = File(...)):\n    file_path = os.path.join(UPLOAD_DIR, file.filename)\n\n    with open(file_path, \"wb\") as buffer:\n        shutil.copyfileobj(file.file, buffer)\n\n    return {\n        \"status\": \"received\",\n        \"filename\": file.filename\n    }\n"
        }
    ]
}
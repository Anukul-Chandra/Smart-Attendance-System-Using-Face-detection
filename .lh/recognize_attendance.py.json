{
    "sourceFile": "recognize_attendance.py",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 11,
            "patches": [
                {
                    "date": 1766771017257,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1766771160967,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -5,9 +5,8 @@\n import numpy as np\n from datetime import datetime\n from deepface import DeepFace\n \n-# Google Sheet helper\n from google_sheet import mark_attendance_sheet\n \n # ---------------- PATHS ----------------\n EMBEDDINGS_DIR = \"embeddings\"\n@@ -34,23 +33,21 @@\n             if row and row[0] == name and row[1] == today:\n                 return True\n     return False\n \n+\n def mark_attendance(name):\n     today = datetime.now().strftime(\"%Y-%m-%d\")\n     time_now = datetime.now().strftime(\"%H:%M:%S\")\n \n-    # ‚úÖ CASE 1: Already marked ‚Üí only sync to Google Sheet\n     if already_marked(name, today):\n         print(f\"‚ö†Ô∏è Attendance already marked for {name}, syncing to sheet\")\n         try:\n             mark_attendance_sheet(name, today, time_now)\n-            print(\"‚òÅÔ∏è Synced to Google Sheet\")\n         except Exception as e:\n             print(\"‚ùå Google Sheet error:\", e)\n         return\n \n-    # ‚úÖ CASE 2: First time today ‚Üí CSV + Google Sheet\n     file_exists = os.path.exists(ATTENDANCE_FILE)\n     with open(ATTENDANCE_FILE, \"a\", newline=\"\") as f:\n         writer = csv.writer(f)\n         if not file_exists:\n@@ -58,12 +55,13 @@\n         writer.writerow([name, today, time_now, \"Present\"])\n \n     try:\n         mark_attendance_sheet(name, today, time_now)\n-        print(f\"üü¢ Attendance marked for {name} (CSV + Sheet)\")\n+        print(f\"üü¢ Attendance marked for {name}\")\n     except Exception as e:\n         print(\"‚ùå Google Sheet error:\", e)\n \n+\n # ---------------- FACE DETECTOR ----------------\n face_cascade = cv2.CascadeClassifier(\n     cv2.data.haarcascades + \"haarcascade_frontalface_default.xml\"\n )\n@@ -76,9 +74,9 @@\n     exit()\n \n print(\"üì∑ Camera started. Show your face...\")\n \n-THRESHOLD = 0.9# Facenet distance threshold\n+THRESHOLD = 0.9  # strict threshold\n \n # ---------------- MAIN LOOP ----------------\n while True:\n     ret, frame = cap.read()\n@@ -90,9 +88,9 @@\n         gray, scaleFactor=1.3, minNeighbors=5, minSize=(80, 80)\n     )\n \n     for (x, y, w, h) in faces:\n-        face_img = frame[y:y+h, x:x+w]\n+        face_img = frame[y:y + h, x:x + w]\n \n         try:\n             rep = DeepFace.represent(\n                 img_path=face_img,\n@@ -102,9 +100,9 @@\n             live_embedding = np.array(rep[0][\"embedding\"])\n         except Exception:\n             continue\n \n-        name_found = \"Unknown\"\n+        name_found = None\n         min_dist = float(\"inf\")\n \n         for name, embeddings in db_embeddings.items():\n             for emb in embeddings:\n@@ -112,44 +110,43 @@\n                 if dist < min_dist:\n                     min_dist = dist\n                     name_found = name\n \n-        # ---------- RECOGNITION RESULT ----------\n-        if min_dist < THRESHOLD:\n+        # ---------------- RESULT ----------------\n+        if name_found and min_dist < THRESHOLD:\n+            label = f\"{name_found}\"\n+            color = (0, 255, 0)\n+\n             mark_attendance(name_found)\n \n-            cv2.rectangle(frame, (x, y), (x+w, y+h), (0, 255, 0), 2)\n+            cv2.rectangle(frame, (x, y), (x + w, y + h), color, 2)\n             cv2.putText(\n-                frame,\n-                name_found,\n-                (x, y - 10),\n-                cv2.FONT_HERSHEY_SIMPLEX,\n-                0.9,\n-                (0, 255, 0),\n-                2\n+                frame, label, (x, y - 10),\n+                cv2.FONT_HERSHEY_SIMPLEX, 0.9, color, 2\n             )\n \n             cv2.imshow(\"Attendance System\", frame)\n             cv2.waitKey(1200)\n \n             cap.release()\n             cv2.destroyAllWindows()\n-            print(\"‚úÖ Attendance process complete. Camera closed.\")\n+            print(\"‚úÖ Attendance complete. Camera closed.\")\n             exit()\n \n         else:\n-            cv2.rectangle(frame, (x, y), (x+w, y+h), (0, 0, 255), 2)\n+            label = \"Face not in database\"\n+            color = (0, 0, 255)\n+\n+            cv2.rectangle(frame, (x, y), (x + w, y + h), color, 2)\n             cv2.putText(\n-                frame,\n-                \"Unknown\",\n-                (x, y - 10),\n-                cv2.FONT_HERSHEY_SIMPLEX,\n-                0.9,\n-                (0, 0, 255),\n-                2\n+                frame, label, (x, y - 10),\n+                cv2.FONT_HERSHEY_SIMPLEX, 0.8, color, 2\n             )\n \n     cv2.imshow(\"Attendance System\", frame)\n \n+    if cv2.waitKey(1) & 0xFF == ord(\"q\"):\n+        break\n+\n # ---------------- CLEANUP ----------------\n cap.release()\n cv2.destroyAllWindows()\n"
                },
                {
                    "date": 1766771169947,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -149,4 +149,5 @@\n \n # ---------------- CLEANUP ----------------\n cap.release()\n cv2.destroyAllWindows()\n+print(\"‚ùå Attendance not marked. Camera closed.\")\n\\ No newline at end of file\n"
                },
                {
                    "date": 1766771541618,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -74,9 +74,9 @@\n     exit()\n \n print(\"üì∑ Camera started. Show your face...\")\n \n-THRESHOLD = 0.9  # strict threshold\n+THRESHOLD = 0.85  # strict & realistic threshold\n \n # ---------------- MAIN LOOP ----------------\n while True:\n     ret, frame = cap.read()\n@@ -100,21 +100,29 @@\n             live_embedding = np.array(rep[0][\"embedding\"])\n         except Exception:\n             continue\n \n+        # ----------- AVERAGE DISTANCE MATCHING -----------\n         name_found = None\n-        min_dist = float(\"inf\")\n+        best_avg_dist = float(\"inf\")\n \n         for name, embeddings in db_embeddings.items():\n+            distances = []\n+\n             for emb in embeddings:\n                 dist = np.linalg.norm(live_embedding - np.array(emb))\n-                if dist < min_dist:\n-                    min_dist = dist\n-                    name_found = name\n+                distances.append(dist)\n \n-        # ---------------- RESULT ----------------\n-        if name_found and min_dist < THRESHOLD:\n-            label = f\"{name_found}\"\n+            avg_dist = np.mean(distances)\n+            print(f\"{name} ‚Üí avg distance: {avg_dist:.3f}\")\n+\n+            if avg_dist < best_avg_dist:\n+                best_avg_dist = avg_dist\n+                name_found = name\n+\n+        # ----------- FINAL DECISION -----------\n+        if name_found and best_avg_dist < THRESHOLD:\n+            label = name_found\n             color = (0, 255, 0)\n \n             mark_attendance(name_found)\n \n@@ -149,5 +157,4 @@\n \n # ---------------- CLEANUP ----------------\n cap.release()\n cv2.destroyAllWindows()\n-print(\"‚ùå Attendance not marked. Camera closed.\")\n\\ No newline at end of file\n"
                },
                {
                    "date": 1766771842848,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -9,8 +9,9 @@\n from google_sheet import mark_attendance_sheet\n \n # ---------------- PATHS ----------------\n EMBEDDINGS_DIR = \"embeddings\"\n+FACE_DB_DIR = \"face_db\"\n ATTENDANCE_FILE = \"attendance.csv\"\n \n # ---------------- LOAD EMBEDDINGS ----------------\n db_embeddings = {}\n@@ -74,9 +75,11 @@\n     exit()\n \n print(\"üì∑ Camera started. Show your face...\")\n \n-THRESHOLD = 0.85  # strict & realistic threshold\n+# Thresholds\n+EMBEDDING_THRESHOLD = 0.9   # candidate selection\n+VERIFY_MODEL = \"Facenet\"   # verification model\n \n # ---------------- MAIN LOOP ----------------\n while True:\n     ret, frame = cap.read()\n@@ -90,42 +93,58 @@\n \n     for (x, y, w, h) in faces:\n         face_img = frame[y:y + h, x:x + w]\n \n+        # ---------- EMBEDDING ----------\n         try:\n             rep = DeepFace.represent(\n                 img_path=face_img,\n-                model_name=\"Facenet\",\n+                model_name=VERIFY_MODEL,\n                 enforce_detection=False\n             )\n             live_embedding = np.array(rep[0][\"embedding\"])\n         except Exception:\n             continue\n \n-        # ----------- AVERAGE DISTANCE MATCHING -----------\n-        name_found = None\n+        # ---------- STAGE 1: CANDIDATE SELECTION ----------\n+        candidate = None\n         best_avg_dist = float(\"inf\")\n \n         for name, embeddings in db_embeddings.items():\n-            distances = []\n+            distances = [\n+                np.linalg.norm(live_embedding - np.array(e))\n+                for e in embeddings\n+            ]\n+            avg_dist = np.mean(distances)\n \n-            for emb in embeddings:\n-                dist = np.linalg.norm(live_embedding - np.array(emb))\n-                distances.append(dist)\n-\n-            avg_dist = np.mean(distances)\n             print(f\"{name} ‚Üí avg distance: {avg_dist:.3f}\")\n \n             if avg_dist < best_avg_dist:\n                 best_avg_dist = avg_dist\n-                name_found = name\n+                candidate = name\n \n-        # ----------- FINAL DECISION -----------\n-        if name_found and best_avg_dist < THRESHOLD:\n-            label = name_found\n+        # ---------- STAGE 2: FACE VERIFICATION ----------\n+        verified = False\n+\n+        if candidate and best_avg_dist < EMBEDDING_THRESHOLD:\n+            ref_img_path = os.path.join(FACE_DB_DIR, candidate, \"img1.jpg\")\n+            try:\n+                result = DeepFace.verify(\n+                    img1_path=face_img,\n+                    img2_path=ref_img_path,\n+                    model_name=VERIFY_MODEL,\n+                    enforce_detection=False\n+                )\n+                verified = result.get(\"verified\", False)\n+            except Exception:\n+                verified = False\n+\n+        # ---------- FINAL DECISION ----------\n+        if verified:\n+            label = candidate\n             color = (0, 255, 0)\n \n-            mark_attendance(name_found)\n+            mark_attendance(candidate)\n \n             cv2.rectangle(frame, (x, y), (x + w, y + h), color, 2)\n             cv2.putText(\n                 frame, label, (x, y - 10),\n"
                },
                {
                    "date": 1766772137696,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,31 +1,22 @@\n import cv2\n import os\n-import pickle\n import csv\n-import numpy as np\n from datetime import datetime\n from deepface import DeepFace\n \n from google_sheet import mark_attendance_sheet\n \n-# ---------------- PATHS ----------------\n-EMBEDDINGS_DIR = \"embeddings\"\n-FACE_DB_DIR = \"face_db\"\n+# ---------------- CONFIG ----------------\n+FACE_DB_DIR = \"face_db/anukul chandra\"   # enrolled user folder\n+REFERENCE_IMG = os.path.join(FACE_DB_DIR, \"img1.jpg\")  # reference face\n ATTENDANCE_FILE = \"attendance.csv\"\n \n-# ---------------- LOAD EMBEDDINGS ----------------\n-db_embeddings = {}\n+VERIFY_MODEL = \"Facenet\"\n+VERIFY_METRIC = \"cosine\"\n+VERIFY_THRESHOLD = 0.40   # 0.35‚Äì0.45 recommended for FaceNet + cosine\n \n-for file in os.listdir(EMBEDDINGS_DIR):\n-    if file.endswith(\".pkl\"):\n-        name = file.replace(\".pkl\", \"\")\n-        with open(os.path.join(EMBEDDINGS_DIR, file), \"rb\") as f:\n-            db_embeddings[name] = pickle.load(f)\n-\n-print(\"‚úÖ Loaded users:\", list(db_embeddings.keys()))\n-\n-# ---------------- ATTENDANCE FUNCTIONS ----------------\n+# ---------------- ATTENDANCE HELPERS ----------------\n def already_marked(name, today):\n     if not os.path.exists(ATTENDANCE_FILE):\n         return False\n     with open(ATTENDANCE_FILE, \"r\") as f:\n@@ -68,83 +59,53 @@\n )\n \n # ---------------- CAMERA ----------------\n cap = cv2.VideoCapture(0)\n-\n if not cap.isOpened():\n     print(\"‚ùå Cannot access camera\")\n     exit()\n \n print(\"üì∑ Camera started. Show your face...\")\n \n-# Thresholds\n-EMBEDDING_THRESHOLD = 0.9   # candidate selection\n-VERIFY_MODEL = \"Facenet\"   # verification model\n-\n # ---------------- MAIN LOOP ----------------\n while True:\n     ret, frame = cap.read()\n     if not ret:\n         break\n \n     gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)\n     faces = face_cascade.detectMultiScale(\n-        gray, scaleFactor=1.3, minNeighbors=5, minSize=(80, 80)\n+        gray, scaleFactor=1.3, minNeighbors=5, minSize=(90, 90)\n     )\n \n     for (x, y, w, h) in faces:\n         face_img = frame[y:y + h, x:x + w]\n \n-        # ---------- EMBEDDING ----------\n+        # ----------- VERIFICATION ONLY -----------\n+        verified = False\n+        distance = None\n+\n         try:\n-            rep = DeepFace.represent(\n-                img_path=face_img,\n+            result = DeepFace.verify(\n+                img1_path=face_img,\n+                img2_path=REFERENCE_IMG,\n                 model_name=VERIFY_MODEL,\n+                distance_metric=VERIFY_METRIC,\n                 enforce_detection=False\n             )\n-            live_embedding = np.array(rep[0][\"embedding\"])\n-        except Exception:\n-            continue\n+            verified = result.get(\"verified\", False)\n+            distance = result.get(\"distance\", None)\n+            print(\"Verify distance:\", distance)\n+        except Exception as e:\n+            print(\"Verify error:\", e)\n+            verified = False\n \n-        # ---------- STAGE 1: CANDIDATE SELECTION ----------\n-        candidate = None\n-        best_avg_dist = float(\"inf\")\n-\n-        for name, embeddings in db_embeddings.items():\n-            distances = [\n-                np.linalg.norm(live_embedding - np.array(e))\n-                for e in embeddings\n-            ]\n-            avg_dist = np.mean(distances)\n-\n-            print(f\"{name} ‚Üí avg distance: {avg_dist:.3f}\")\n-\n-            if avg_dist < best_avg_dist:\n-                best_avg_dist = avg_dist\n-                candidate = name\n-\n-        # ---------- STAGE 2: FACE VERIFICATION ----------\n-        verified = False\n-\n-        if candidate and best_avg_dist < EMBEDDING_THRESHOLD:\n-            ref_img_path = os.path.join(FACE_DB_DIR, candidate, \"img1.jpg\")\n-            try:\n-                result = DeepFace.verify(\n-                    img1_path=face_img,\n-                    img2_path=ref_img_path,\n-                    model_name=VERIFY_MODEL,\n-                    enforce_detection=False\n-                )\n-                verified = result.get(\"verified\", False)\n-            except Exception:\n-                verified = False\n-\n-        # ---------- FINAL DECISION ----------\n-        if verified:\n-            label = candidate\n+        # ----------- DECISION -----------\n+        if verified and distance is not None and distance < VERIFY_THRESHOLD:\n+            label = \"anukul chandra\"\n             color = (0, 255, 0)\n \n-            mark_attendance(candidate)\n+            mark_attendance(\"anukul chandra\")\n \n             cv2.rectangle(frame, (x, y), (x + w, y + h), color, 2)\n             cv2.putText(\n                 frame, label, (x, y - 10),\n"
                },
                {
                    "date": 1766772406112,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,140 +1,99 @@\n import cv2\n import os\n-import csv\n+import numpy as np\n from datetime import datetime\n from deepface import DeepFace\n+import csv\n \n-from google_sheet import mark_attendance_sheet\n-\n # ---------------- CONFIG ----------------\n-FACE_DB_DIR = \"face_db/anukul chandra\"   # enrolled user folder\n-REFERENCE_IMG = os.path.join(FACE_DB_DIR, \"img1.jpg\")  # reference face\n+REFERENCE_IMG = \"face_db/anukul chandra/img1.jpg\"\n ATTENDANCE_FILE = \"attendance.csv\"\n \n-VERIFY_MODEL = \"Facenet\"\n-VERIFY_METRIC = \"cosine\"\n-VERIFY_THRESHOLD = 0.40   # 0.35‚Äì0.45 recommended for FaceNet + cosine\n+MODEL_NAME = \"Facenet\"\n+DISTANCE_METRIC = \"cosine\"\n+THRESHOLD = 0.40   # strict (VERY IMPORTANT)\n \n-# ---------------- ATTENDANCE HELPERS ----------------\n-def already_marked(name, today):\n-    if not os.path.exists(ATTENDANCE_FILE):\n-        return False\n-    with open(ATTENDANCE_FILE, \"r\") as f:\n-        reader = csv.reader(f)\n-        for row in reader:\n-            if row and row[0] == name and row[1] == today:\n-                return True\n-    return False\n-\n-\n+# ---------------- ATTENDANCE ----------------\n def mark_attendance(name):\n     today = datetime.now().strftime(\"%Y-%m-%d\")\n     time_now = datetime.now().strftime(\"%H:%M:%S\")\n \n-    if already_marked(name, today):\n-        print(f\"‚ö†Ô∏è Attendance already marked for {name}, syncing to sheet\")\n-        try:\n-            mark_attendance_sheet(name, today, time_now)\n-        except Exception as e:\n-            print(\"‚ùå Google Sheet error:\", e)\n-        return\n+    if os.path.exists(ATTENDANCE_FILE):\n+        with open(ATTENDANCE_FILE, \"r\") as f:\n+            reader = csv.reader(f)\n+            for row in reader:\n+                if row and row[0] == name and row[1] == today:\n+                    print(\"‚ö†Ô∏è Attendance already marked\")\n+                    return\n \n-    file_exists = os.path.exists(ATTENDANCE_FILE)\n     with open(ATTENDANCE_FILE, \"a\", newline=\"\") as f:\n         writer = csv.writer(f)\n-        if not file_exists:\n+        if f.tell() == 0:\n             writer.writerow([\"Name\", \"Date\", \"Time\", \"Status\"])\n         writer.writerow([name, today, time_now, \"Present\"])\n \n-    try:\n-        mark_attendance_sheet(name, today, time_now)\n-        print(f\"üü¢ Attendance marked for {name}\")\n-    except Exception as e:\n-        print(\"‚ùå Google Sheet error:\", e)\n+    print(f\"üü¢ Attendance marked for {name}\")\n \n-\n-# ---------------- FACE DETECTOR ----------------\n-face_cascade = cv2.CascadeClassifier(\n-    cv2.data.haarcascades + \"haarcascade_frontalface_default.xml\"\n-)\n-\n # ---------------- CAMERA ----------------\n cap = cv2.VideoCapture(0)\n+\n if not cap.isOpened():\n-    print(\"‚ùå Cannot access camera\")\n+    print(\"‚ùå Camera not accessible\")\n     exit()\n \n-print(\"üì∑ Camera started. Show your face...\")\n+print(\"üì∑ Camera started. Look at the camera...\")\n \n # ---------------- MAIN LOOP ----------------\n while True:\n     ret, frame = cap.read()\n     if not ret:\n         break\n \n-    gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)\n-    faces = face_cascade.detectMultiScale(\n-        gray, scaleFactor=1.3, minNeighbors=5, minSize=(90, 90)\n-    )\n+    try:\n+        # DeepFace auto face detection + verification\n+        result = DeepFace.verify(\n+            img1_path=frame,\n+            img2_path=REFERENCE_IMG,\n+            model_name=MODEL_NAME,\n+            distance_metric=DISTANCE_METRIC,\n+            enforce_detection=True\n+        )\n \n-    for (x, y, w, h) in faces:\n-        face_img = frame[y:y + h, x:x + w]\n+        distance = result[\"distance\"]\n+        verified = result[\"verified\"]\n \n-        # ----------- VERIFICATION ONLY -----------\n-        verified = False\n-        distance = None\n+        print(\"DEBUG ‚Üí distance:\", distance)\n \n-        try:\n-            result = DeepFace.verify(\n-                img1_path=face_img,\n-                img2_path=REFERENCE_IMG,\n-                model_name=VERIFY_MODEL,\n-                distance_metric=VERIFY_METRIC,\n-                enforce_detection=False\n-            )\n-            verified = result.get(\"verified\", False)\n-            distance = result.get(\"distance\", None)\n-            print(\"Verify distance:\", distance)\n-        except Exception as e:\n-            print(\"Verify error:\", e)\n-            verified = False\n-\n-        # ----------- DECISION -----------\n-        if verified and distance is not None and distance < VERIFY_THRESHOLD:\n-            label = \"anukul chandra\"\n+        if verified and distance < THRESHOLD:\n+            name = \"anukul chandra\"\n+            mark_attendance(name)\n+            label = f\"{name} ‚úÖ\"\n             color = (0, 255, 0)\n \n-            mark_attendance(\"anukul chandra\")\n+            cv2.putText(frame, label, (20, 40),\n+                        cv2.FONT_HERSHEY_SIMPLEX, 1, color, 2)\n \n-            cv2.rectangle(frame, (x, y), (x + w, y + h), color, 2)\n-            cv2.putText(\n-                frame, label, (x, y - 10),\n-                cv2.FONT_HERSHEY_SIMPLEX, 0.9, color, 2\n-            )\n+            cv2.imshow(\"Smart Attendance\", frame)\n+            cv2.waitKey(1500)\n+            break\n \n-            cv2.imshow(\"Attendance System\", frame)\n-            cv2.waitKey(1200)\n-\n-            cap.release()\n-            cv2.destroyAllWindows()\n-            print(\"‚úÖ Attendance complete. Camera closed.\")\n-            exit()\n-\n         else:\n-            label = \"Face not in database\"\n+            label = \"Unknown ‚ùå\"\n             color = (0, 0, 255)\n \n-            cv2.rectangle(frame, (x, y), (x + w, y + h), color, 2)\n-            cv2.putText(\n-                frame, label, (x, y - 10),\n-                cv2.FONT_HERSHEY_SIMPLEX, 0.8, color, 2\n-            )\n+    except Exception:\n+        label = \"No Face ‚ùå\"\n+        color = (0, 0, 255)\n \n-    cv2.imshow(\"Attendance System\", frame)\n+    cv2.putText(frame, label, (20, 40),\n+                cv2.FONT_HERSHEY_SIMPLEX, 1, color, 2)\n \n-    if cv2.waitKey(1) & 0xFF == ord(\"q\"):\n+    cv2.imshow(\"Smart Attendance\", frame)\n+\n+    if cv2.waitKey(1) & 0xFF == 27:\n         break\n \n # ---------------- CLEANUP ----------------\n cap.release()\n cv2.destroyAllWindows()\n+print(\"‚úÖ Camera closed\")\n"
                },
                {
                    "date": 1766772698617,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,99 +1,71 @@\n import cv2\n import os\n+import pickle\n import numpy as np\n-from datetime import datetime\n from deepface import DeepFace\n-import csv\n \n # ---------------- CONFIG ----------------\n-REFERENCE_IMG = \"face_db/anukul chandra/img1.jpg\"\n-ATTENDANCE_FILE = \"attendance.csv\"\n-\n+EMBEDDINGS_DIR = \"embeddings\"\n MODEL_NAME = \"Facenet\"\n-DISTANCE_METRIC = \"cosine\"\n-THRESHOLD = 0.40   # strict (VERY IMPORTANT)\n+DISTANCE_THRESHOLD = 0.55   # strict\n \n-# ---------------- ATTENDANCE ----------------\n-def mark_attendance(name):\n-    today = datetime.now().strftime(\"%Y-%m-%d\")\n-    time_now = datetime.now().strftime(\"%H:%M:%S\")\n+# ---------------- LOAD EMBEDDINGS ----------------\n+db = {}\n \n-    if os.path.exists(ATTENDANCE_FILE):\n-        with open(ATTENDANCE_FILE, \"r\") as f:\n-            reader = csv.reader(f)\n-            for row in reader:\n-                if row and row[0] == name and row[1] == today:\n-                    print(\"‚ö†Ô∏è Attendance already marked\")\n-                    return\n+for file in os.listdir(EMBEDDINGS_DIR):\n+    if file.endswith(\".pkl\"):\n+        name = file.replace(\".pkl\", \"\")\n+        with open(os.path.join(EMBEDDINGS_DIR, file), \"rb\") as f:\n+            db[name] = pickle.load(f)\n \n-    with open(ATTENDANCE_FILE, \"a\", newline=\"\") as f:\n-        writer = csv.writer(f)\n-        if f.tell() == 0:\n-            writer.writerow([\"Name\", \"Date\", \"Time\", \"Status\"])\n-        writer.writerow([name, today, time_now, \"Present\"])\n+print(\"‚úÖ Loaded users:\", list(db.keys()))\n \n-    print(f\"üü¢ Attendance marked for {name}\")\n-\n # ---------------- CAMERA ----------------\n cap = cv2.VideoCapture(0)\n+print(\"üì∑ Camera started\")\n \n-if not cap.isOpened():\n-    print(\"‚ùå Camera not accessible\")\n-    exit()\n-\n-print(\"üì∑ Camera started. Look at the camera...\")\n-\n-# ---------------- MAIN LOOP ----------------\n while True:\n     ret, frame = cap.read()\n     if not ret:\n         break\n \n     try:\n-        # DeepFace auto face detection + verification\n-        result = DeepFace.verify(\n-            img1_path=frame,\n-            img2_path=REFERENCE_IMG,\n+        reps = DeepFace.represent(\n+            img_path=frame,\n             model_name=MODEL_NAME,\n-            distance_metric=DISTANCE_METRIC,\n             enforce_detection=True\n         )\n+        live_emb = np.array(reps[0][\"embedding\"])\n+    except:\n+        cv2.imshow(\"Attendance\", frame)\n+        continue\n \n-        distance = result[\"distance\"]\n-        verified = result[\"verified\"]\n+    identity = \"Unknown\"\n+    min_dist = 999\n \n-        print(\"DEBUG ‚Üí distance:\", distance)\n+    for name, embeddings in db.items():\n+        for emb in embeddings:\n+            dist = np.linalg.norm(live_emb - emb)\n+            if dist < min_dist:\n+                min_dist = dist\n+                identity = name\n \n-        if verified and distance < THRESHOLD:\n-            name = \"anukul chandra\"\n-            mark_attendance(name)\n-            label = f\"{name} ‚úÖ\"\n-            color = (0, 255, 0)\n+    print(\"DEBUG distance:\", min_dist)\n \n-            cv2.putText(frame, label, (20, 40),\n-                        cv2.FONT_HERSHEY_SIMPLEX, 1, color, 2)\n-\n-            cv2.imshow(\"Smart Attendance\", frame)\n-            cv2.waitKey(1500)\n-            break\n-\n-        else:\n-            label = \"Unknown ‚ùå\"\n-            color = (0, 0, 255)\n-\n-    except Exception:\n-        label = \"No Face ‚ùå\"\n+    if min_dist < DISTANCE_THRESHOLD:\n+        label = f\"{identity} ‚úÖ\"\n+        color = (0, 255, 0)\n+    else:\n+        label = \"Unknown ‚ùå\"\n         color = (0, 0, 255)\n \n     cv2.putText(frame, label, (20, 40),\n                 cv2.FONT_HERSHEY_SIMPLEX, 1, color, 2)\n \n-    cv2.imshow(\"Smart Attendance\", frame)\n+    cv2.imshow(\"Attendance\", frame)\n \n     if cv2.waitKey(1) & 0xFF == 27:\n         break\n \n-# ---------------- CLEANUP ----------------\n cap.release()\n cv2.destroyAllWindows()\n-print(\"‚úÖ Camera closed\")\n"
                },
                {
                    "date": 1766773416558,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,71 +1,227 @@\n+# import cv2\n+# import os\n+# import pickle\n+# import numpy as np\n+# from deepface import DeepFace\n+\n+# # ---------------- CONFIG ----------------\n+# EMBEDDINGS_DIR = \"embeddings\"\n+# MODEL_NAME = \"Facenet\"\n+# DISTANCE_THRESHOLD = 0.55   # strict\n+\n+# # ---------------- LOAD EMBEDDINGS ----------------\n+# db = {}\n+\n+# for file in os.listdir(EMBEDDINGS_DIR):\n+#     if file.endswith(\".pkl\"):\n+#         name = file.replace(\".pkl\", \"\")\n+#         with open(os.path.join(EMBEDDINGS_DIR, file), \"rb\") as f:\n+#             db[name] = pickle.load(f)\n+\n+# print(\"‚úÖ Loaded users:\", list(db.keys()))\n+\n+# # ---------------- CAMERA ----------------\n+# cap = cv2.VideoCapture(0)\n+# print(\"üì∑ Camera started\")\n+\n+# while True:\n+#     ret, frame = cap.read()\n+#     if not ret:\n+#         break\n+\n+#     try:\n+#         reps = DeepFace.represent(\n+#             img_path=frame,\n+#             model_name=MODEL_NAME,\n+#             enforce_detection=True\n+#         )\n+#         live_emb = np.array(reps[0][\"embedding\"])\n+#     except:\n+#         cv2.imshow(\"Attendance\", frame)\n+#         continue\n+\n+#     identity = \"Unknown\"\n+#     min_dist = 999\n+\n+#     for name, embeddings in db.items():\n+#         for emb in embeddings:\n+#             dist = np.linalg.norm(live_emb - emb)\n+#             if dist < min_dist:\n+#                 min_dist = dist\n+#                 identity = name\n+\n+#     print(\"DEBUG distance:\", min_dist)\n+\n+#     if min_dist < DISTANCE_THRESHOLD:\n+#         label = f\"{identity} ‚úÖ\"\n+#         color = (0, 255, 0)\n+#     else:\n+#         label = \"Unknown ‚ùå\"\n+#         color = (0, 0, 255)\n+\n+#     cv2.putText(frame, label, (20, 40),\n+#                 cv2.FONT_HERSHEY_SIMPLEX, 1, color, 2)\n+\n+#     cv2.imshow(\"Attendance\", frame)\n+\n+#     if cv2.waitKey(1) & 0xFF == 27:\n+#         break\n+\n+# cap.release()\n+# cv2.destroyAllWindows()\n+\n import cv2\n import os\n import pickle\n+import csv\n import numpy as np\n+from datetime import datetime\n from deepface import DeepFace\n \n-# ---------------- CONFIG ----------------\n+# Google Sheet helper\n+from google_sheet import mark_attendance_sheet\n+\n+# ---------------- PATHS ----------------\n EMBEDDINGS_DIR = \"embeddings\"\n-MODEL_NAME = \"Facenet\"\n-DISTANCE_THRESHOLD = 0.55   # strict\n+ATTENDANCE_FILE = \"attendance.csv\"\n \n # ---------------- LOAD EMBEDDINGS ----------------\n-db = {}\n+db_embeddings = {}\n \n for file in os.listdir(EMBEDDINGS_DIR):\n     if file.endswith(\".pkl\"):\n         name = file.replace(\".pkl\", \"\")\n         with open(os.path.join(EMBEDDINGS_DIR, file), \"rb\") as f:\n-            db[name] = pickle.load(f)\n+            db_embeddings[name] = pickle.load(f)\n \n-print(\"‚úÖ Loaded users:\", list(db.keys()))\n+print(\"‚úÖ Loaded users:\", list(db_embeddings.keys()))\n \n+# ---------------- ATTENDANCE FUNCTIONS ----------------\n+def already_marked(name, today):\n+    if not os.path.exists(ATTENDANCE_FILE):\n+        return False\n+    with open(ATTENDANCE_FILE, \"r\") as f:\n+        reader = csv.reader(f)\n+        for row in reader:\n+            if row and row[0] == name and row[1] == today:\n+                return True\n+    return False\n+\n+def mark_attendance(name):\n+    today = datetime.now().strftime(\"%Y-%m-%d\")\n+    time_now = datetime.now().strftime(\"%H:%M:%S\")\n+\n+    # ‚úÖ CASE 1: Already marked ‚Üí only sync to Google Sheet\n+    if already_marked(name, today):\n+        print(f\"‚ö†Ô∏è Attendance already marked for {name}, syncing to sheet\")\n+        try:\n+            mark_attendance_sheet(name, today, time_now)\n+            print(\"‚òÅÔ∏è Synced to Google Sheet\")\n+        except Exception as e:\n+            print(\"‚ùå Google Sheet error:\", e)\n+        return\n+\n+    # ‚úÖ CASE 2: First time today ‚Üí CSV + Google Sheet\n+    file_exists = os.path.exists(ATTENDANCE_FILE)\n+    with open(ATTENDANCE_FILE, \"a\", newline=\"\") as f:\n+        writer = csv.writer(f)\n+        if not file_exists:\n+            writer.writerow([\"Name\", \"Date\", \"Time\", \"Status\"])\n+        writer.writerow([name, today, time_now, \"Present\"])\n+\n+    try:\n+        mark_attendance_sheet(name, today, time_now)\n+        print(f\"üü¢ Attendance marked for {name} (CSV + Sheet)\")\n+    except Exception as e:\n+        print(\"‚ùå Google Sheet error:\", e)\n+\n+# ---------------- FACE DETECTOR ----------------\n+face_cascade = cv2.CascadeClassifier(\n+    cv2.data.haarcascades + \"haarcascade_frontalface_default.xml\"\n+)\n+\n # ---------------- CAMERA ----------------\n cap = cv2.VideoCapture(0)\n-print(\"üì∑ Camera started\")\n \n+if not cap.isOpened():\n+    print(\"‚ùå Cannot access camera\")\n+    exit()\n+\n+print(\"üì∑ Camera started. Show your face...\")\n+\n+THRESHOLD = 10  # Facenet distance threshold\n+\n+# ---------------- MAIN LOOP ----------------\n while True:\n     ret, frame = cap.read()\n     if not ret:\n         break\n \n-    try:\n-        reps = DeepFace.represent(\n-            img_path=frame,\n-            model_name=MODEL_NAME,\n-            enforce_detection=True\n-        )\n-        live_emb = np.array(reps[0][\"embedding\"])\n-    except:\n-        cv2.imshow(\"Attendance\", frame)\n-        continue\n+    gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)\n+    faces = face_cascade.detectMultiScale(\n+        gray, scaleFactor=1.3, minNeighbors=5, minSize=(80, 80)\n+    )\n \n-    identity = \"Unknown\"\n-    min_dist = 999\n+    for (x, y, w, h) in faces:\n+        face_img = frame[y:y+h, x:x+w]\n \n-    for name, embeddings in db.items():\n-        for emb in embeddings:\n-            dist = np.linalg.norm(live_emb - emb)\n-            if dist < min_dist:\n-                min_dist = dist\n-                identity = name\n+        try:\n+            rep = DeepFace.represent(\n+                img_path=face_img,\n+                model_name=\"Facenet\",\n+                enforce_detection=False\n+            )\n+            live_embedding = np.array(rep[0][\"embedding\"])\n+        except Exception:\n+            continue\n \n-    print(\"DEBUG distance:\", min_dist)\n+        name_found = \"Unknown\"\n+        min_dist = float(\"inf\")\n \n-    if min_dist < DISTANCE_THRESHOLD:\n-        label = f\"{identity} ‚úÖ\"\n-        color = (0, 255, 0)\n-    else:\n-        label = \"Unknown ‚ùå\"\n-        color = (0, 0, 255)\n+        for name, embeddings in db_embeddings.items():\n+            for emb in embeddings:\n+                dist = np.linalg.norm(live_embedding - np.array(emb))\n+                if dist < min_dist:\n+                    min_dist = dist\n+                    name_found = name\n \n-    cv2.putText(frame, label, (20, 40),\n-                cv2.FONT_HERSHEY_SIMPLEX, 1, color, 2)\n+        # ---------- RECOGNITION RESULT ----------\n+        if min_dist < THRESHOLD:\n+            mark_attendance(name_found)\n \n-    cv2.imshow(\"Attendance\", frame)\n+            cv2.rectangle(frame, (x, y), (x+w, y+h), (0, 255, 0), 2)\n+            cv2.putText(\n+                frame,\n+                name_found,\n+                (x, y - 10),\n+                cv2.FONT_HERSHEY_SIMPLEX,\n+                0.9,\n+                (0, 255, 0),\n+                2\n+            )\n \n-    if cv2.waitKey(1) & 0xFF == 27:\n-        break\n+            cv2.imshow(\"Attendance System\", frame)\n+            cv2.waitKey(1200)\n \n+            cap.release()\n+            cv2.destroyAllWindows()\n+            print(\"‚úÖ Attendance process complete. Camera closed.\")\n+            exit()\n+\n+        else:\n+            cv2.rectangle(frame, (x, y), (x+w, y+h), (0, 0, 255), 2)\n+            cv2.putText(\n+                frame,\n+                \"Unknown\",\n+                (x, y - 10),\n+                cv2.FONT_HERSHEY_SIMPLEX,\n+                0.9,\n+                (0, 0, 255),\n+                2\n+            )\n+\n+    cv2.imshow(\"Attendance System\", frame)\n+\n+# ---------------- CLEANUP ----------------\n cap.release()\n-cv2.destroyAllWindows()\n+cv2.destroyAllWindows()\n\\ No newline at end of file\n"
                },
                {
                    "date": 1766774373416,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,103 +1,34 @@\n-# import cv2\n-# import os\n-# import pickle\n-# import numpy as np\n-# from deepface import DeepFace\n-\n-# # ---------------- CONFIG ----------------\n-# EMBEDDINGS_DIR = \"embeddings\"\n-# MODEL_NAME = \"Facenet\"\n-# DISTANCE_THRESHOLD = 0.55   # strict\n-\n-# # ---------------- LOAD EMBEDDINGS ----------------\n-# db = {}\n-\n-# for file in os.listdir(EMBEDDINGS_DIR):\n-#     if file.endswith(\".pkl\"):\n-#         name = file.replace(\".pkl\", \"\")\n-#         with open(os.path.join(EMBEDDINGS_DIR, file), \"rb\") as f:\n-#             db[name] = pickle.load(f)\n-\n-# print(\"‚úÖ Loaded users:\", list(db.keys()))\n-\n-# # ---------------- CAMERA ----------------\n-# cap = cv2.VideoCapture(0)\n-# print(\"üì∑ Camera started\")\n-\n-# while True:\n-#     ret, frame = cap.read()\n-#     if not ret:\n-#         break\n-\n-#     try:\n-#         reps = DeepFace.represent(\n-#             img_path=frame,\n-#             model_name=MODEL_NAME,\n-#             enforce_detection=True\n-#         )\n-#         live_emb = np.array(reps[0][\"embedding\"])\n-#     except:\n-#         cv2.imshow(\"Attendance\", frame)\n-#         continue\n-\n-#     identity = \"Unknown\"\n-#     min_dist = 999\n-\n-#     for name, embeddings in db.items():\n-#         for emb in embeddings:\n-#             dist = np.linalg.norm(live_emb - emb)\n-#             if dist < min_dist:\n-#                 min_dist = dist\n-#                 identity = name\n-\n-#     print(\"DEBUG distance:\", min_dist)\n-\n-#     if min_dist < DISTANCE_THRESHOLD:\n-#         label = f\"{identity} ‚úÖ\"\n-#         color = (0, 255, 0)\n-#     else:\n-#         label = \"Unknown ‚ùå\"\n-#         color = (0, 0, 255)\n-\n-#     cv2.putText(frame, label, (20, 40),\n-#                 cv2.FONT_HERSHEY_SIMPLEX, 1, color, 2)\n-\n-#     cv2.imshow(\"Attendance\", frame)\n-\n-#     if cv2.waitKey(1) & 0xFF == 27:\n-#         break\n-\n-# cap.release()\n-# cv2.destroyAllWindows()\n-\n import cv2\n import os\n import pickle\n import csv\n import numpy as np\n from datetime import datetime\n from deepface import DeepFace\n \n-# Google Sheet helper\n from google_sheet import mark_attendance_sheet\n \n-# ---------------- PATHS ----------------\n+# ---------------- CONFIG ----------------\n EMBEDDINGS_DIR = \"embeddings\"\n ATTENDANCE_FILE = \"attendance.csv\"\n \n+MODEL_NAME = \"Facenet\"\n+DETECTOR = \"retinaface\"\n+THRESHOLD = 0.9   # üî• correct threshold\n+\n # ---------------- LOAD EMBEDDINGS ----------------\n db_embeddings = {}\n \n for file in os.listdir(EMBEDDINGS_DIR):\n     if file.endswith(\".pkl\"):\n         name = file.replace(\".pkl\", \"\")\n         with open(os.path.join(EMBEDDINGS_DIR, file), \"rb\") as f:\n-            db_embeddings[name] = pickle.load(f)\n+            db_embeddings[name] = np.array(pickle.load(f))\n \n print(\"‚úÖ Loaded users:\", list(db_embeddings.keys()))\n \n-# ---------------- ATTENDANCE FUNCTIONS ----------------\n+# ---------------- ATTENDANCE ----------------\n def already_marked(name, today):\n     if not os.path.exists(ATTENDANCE_FILE):\n         return False\n     with open(ATTENDANCE_FILE, \"r\") as f:\n@@ -110,118 +41,63 @@\n def mark_attendance(name):\n     today = datetime.now().strftime(\"%Y-%m-%d\")\n     time_now = datetime.now().strftime(\"%H:%M:%S\")\n \n-    # ‚úÖ CASE 1: Already marked ‚Üí only sync to Google Sheet\n     if already_marked(name, today):\n-        print(f\"‚ö†Ô∏è Attendance already marked for {name}, syncing to sheet\")\n-        try:\n-            mark_attendance_sheet(name, today, time_now)\n-            print(\"‚òÅÔ∏è Synced to Google Sheet\")\n-        except Exception as e:\n-            print(\"‚ùå Google Sheet error:\", e)\n+        print(f\"‚ö†Ô∏è Already marked: {name}\")\n+        mark_attendance_sheet(name, today, time_now)\n         return\n \n-    # ‚úÖ CASE 2: First time today ‚Üí CSV + Google Sheet\n     file_exists = os.path.exists(ATTENDANCE_FILE)\n     with open(ATTENDANCE_FILE, \"a\", newline=\"\") as f:\n         writer = csv.writer(f)\n         if not file_exists:\n             writer.writerow([\"Name\", \"Date\", \"Time\", \"Status\"])\n         writer.writerow([name, today, time_now, \"Present\"])\n \n-    try:\n-        mark_attendance_sheet(name, today, time_now)\n-        print(f\"üü¢ Attendance marked for {name} (CSV + Sheet)\")\n-    except Exception as e:\n-        print(\"‚ùå Google Sheet error:\", e)\n+    mark_attendance_sheet(name, today, time_now)\n+    print(f\"üü¢ Attendance marked for {name}\")\n \n-# ---------------- FACE DETECTOR ----------------\n-face_cascade = cv2.CascadeClassifier(\n-    cv2.data.haarcascades + \"haarcascade_frontalface_default.xml\"\n-)\n-\n # ---------------- CAMERA ----------------\n cap = cv2.VideoCapture(0)\n+print(\"üì∑ Camera started...\")\n \n-if not cap.isOpened():\n-    print(\"‚ùå Cannot access camera\")\n-    exit()\n-\n-print(\"üì∑ Camera started. Show your face...\")\n-\n-THRESHOLD = 10  # Facenet distance threshold\n-\n-# ---------------- MAIN LOOP ----------------\n while True:\n     ret, frame = cap.read()\n     if not ret:\n         break\n \n-    gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)\n-    faces = face_cascade.detectMultiScale(\n-        gray, scaleFactor=1.3, minNeighbors=5, minSize=(80, 80)\n-    )\n+    try:\n+        reps = DeepFace.represent(\n+            img_path=frame,\n+            model_name=MODEL_NAME,\n+            detector_backend=DETECTOR,\n+            enforce_detection=True\n+        )\n \n-    for (x, y, w, h) in faces:\n-        face_img = frame[y:y+h, x:x+w]\n+        live_emb = np.array(reps[0][\"embedding\"])\n \n-        try:\n-            rep = DeepFace.represent(\n-                img_path=face_img,\n-                model_name=\"Facenet\",\n-                enforce_detection=False\n-            )\n-            live_embedding = np.array(rep[0][\"embedding\"])\n-        except Exception:\n-            continue\n-\n-        name_found = \"Unknown\"\n+        best_match = \"Unknown\"\n         min_dist = float(\"inf\")\n \n         for name, embeddings in db_embeddings.items():\n-            for emb in embeddings:\n-                dist = np.linalg.norm(live_embedding - np.array(emb))\n-                if dist < min_dist:\n-                    min_dist = dist\n-                    name_found = name\n+            dists = np.linalg.norm(embeddings - live_emb, axis=1)\n+            avg_dist = np.mean(dists)\n \n-        # ---------- RECOGNITION RESULT ----------\n-        if min_dist < THRESHOLD:\n-            mark_attendance(name_found)\n+            if avg_dist < min_dist:\n+                min_dist = avg_dist\n+                best_match = name\n \n-            cv2.rectangle(frame, (x, y), (x+w, y+h), (0, 255, 0), 2)\n-            cv2.putText(\n-                frame,\n-                name_found,\n-                (x, y - 10),\n-                cv2.FONT_HERSHEY_SIMPLEX,\n-                0.9,\n-                (0, 255, 0),\n-                2\n-            )\n+        print(f\"DEBUG ‚Üí {best_match}, distance={min_dist}\")\n \n-            cv2.imshow(\"Attendance System\", frame)\n-            cv2.waitKey(1200)\n-\n-            cap.release()\n-            cv2.destroyAllWindows()\n\\ No newline at end of file\n-            print(\"‚úÖ Attendance process complete. Camera closed.\")\n-            exit()\n-\n+        if min_dist < THRESHOLD:\n+            mark_attendance(best_match)\n+            print(\"‚úÖ Recognized:\", best_match)\n+            break\n         else:\n-            cv2.rectangle(frame, (x, y), (x+w, y+h), (0, 0, 255), 2)\n-            cv2.putText(\n-                frame,\n-                \"Unknown\",\n-                (x, y - 10),\n-                cv2.FONT_HERSHEY_SIMPLEX,\n-                0.9,\n-                (0, 0, 255),\n-                2\n-            )\n+            print(\"‚ùå Unknown face\")\n \n-    cv2.imshow(\"Attendance System\", frame)\n+    except Exception:\n+        print(\"‚ö†Ô∏è No face detected\")\n \n-# ---------------- CLEANUP ----------------\n cap.release()\n-cv2.destroyAllWindows()\n+cv2.destroyAllWindows()\n"
                },
                {
                    "date": 1766774431331,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,4 +1,164 @@\n+\n+\n+# import cv2\n+# import os\n+# import pickle\n+# import csv\n+# import numpy as np\n+# from datetime import datetime\n+# from deepface import DeepFace\n+\n+# # Google Sheet helper\n+# from google_sheet import mark_attendance_sheet\n+\n+# # ---------------- PATHS ----------------\n+# EMBEDDINGS_DIR = \"embeddings\"\n+# ATTENDANCE_FILE = \"attendance.csv\"\n+\n+# # ---------------- LOAD EMBEDDINGS ----------------\n+# db_embeddings = {}\n+\n+# for file in os.listdir(EMBEDDINGS_DIR):\n+#     if file.endswith(\".pkl\"):\n+#         name = file.replace(\".pkl\", \"\")\n+#         with open(os.path.join(EMBEDDINGS_DIR, file), \"rb\") as f:\n+#             db_embeddings[name] = pickle.load(f)\n+\n+# print(\"‚úÖ Loaded users:\", list(db_embeddings.keys()))\n+\n+# # ---------------- ATTENDANCE FUNCTIONS ----------------\n+# def already_marked(name, today):\n+#     if not os.path.exists(ATTENDANCE_FILE):\n+#         return False\n+#     with open(ATTENDANCE_FILE, \"r\") as f:\n+#         reader = csv.reader(f)\n+#         for row in reader:\n+#             if row and row[0] == name and row[1] == today:\n+#                 return True\n+#     return False\n+\n+# def mark_attendance(name):\n+#     today = datetime.now().strftime(\"%Y-%m-%d\")\n+#     time_now = datetime.now().strftime(\"%H:%M:%S\")\n+\n+#     # ‚úÖ CASE 1: Already marked ‚Üí only sync to Google Sheet\n+#     if already_marked(name, today):\n+#         print(f\"‚ö†Ô∏è Attendance already marked for {name}, syncing to sheet\")\n+#         try:\n+#             mark_attendance_sheet(name, today, time_now)\n+#             print(\"‚òÅÔ∏è Synced to Google Sheet\")\n+#         except Exception as e:\n+#             print(\"‚ùå Google Sheet error:\", e)\n+#         return\n+\n+#     # ‚úÖ CASE 2: First time today ‚Üí CSV + Google Sheet\n+#     file_exists = os.path.exists(ATTENDANCE_FILE)\n+#     with open(ATTENDANCE_FILE, \"a\", newline=\"\") as f:\n+#         writer = csv.writer(f)\n+#         if not file_exists:\n+#             writer.writerow([\"Name\", \"Date\", \"Time\", \"Status\"])\n+#         writer.writerow([name, today, time_now, \"Present\"])\n+\n+#     try:\n+#         mark_attendance_sheet(name, today, time_now)\n+#         print(f\"üü¢ Attendance marked for {name} (CSV + Sheet)\")\n+#     except Exception as e:\n+#         print(\"‚ùå Google Sheet error:\", e)\n+\n+# # ---------------- FACE DETECTOR ----------------\n+# face_cascade = cv2.CascadeClassifier(\n+#     cv2.data.haarcascades + \"haarcascade_frontalface_default.xml\"\n+# )\n+\n+# # ---------------- CAMERA ----------------\n+# cap = cv2.VideoCapture(0)\n+\n+# if not cap.isOpened():\n+#     print(\"‚ùå Cannot access camera\")\n+#     exit()\n+\n+# print(\"üì∑ Camera started. Show your face...\")\n+\n+# THRESHOLD = 10  # Facenet distance threshold\n+\n+# # ---------------- MAIN LOOP ----------------\n+# while True:\n+#     ret, frame = cap.read()\n+#     if not ret:\n+#         break\n+\n+#     gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)\n+#     faces = face_cascade.detectMultiScale(\n+#         gray, scaleFactor=1.3, minNeighbors=5, minSize=(80, 80)\n+#     )\n+\n+#     for (x, y, w, h) in faces:\n+#         face_img = frame[y:y+h, x:x+w]\n+\n+#         try:\n+#             rep = DeepFace.represent(\n+#                 img_path=face_img,\n+#                 model_name=\"Facenet\",\n+#                 enforce_detection=False\n+#             )\n+#             live_embedding = np.array(rep[0][\"embedding\"])\n+#         except Exception:\n+#             continue\n+\n+#         name_found = \"Unknown\"\n+#         min_dist = float(\"inf\")\n+\n+#         for name, embeddings in db_embeddings.items():\n+#             for emb in embeddings:\n+#                 dist = np.linalg.norm(live_embedding - np.array(emb))\n+#                 if dist < min_dist:\n+#                     min_dist = dist\n+#                     name_found = name\n+\n+#         # ---------- RECOGNITION RESULT ----------\n+#         if min_dist < THRESHOLD:\n+#             mark_attendance(name_found)\n+\n+#             cv2.rectangle(frame, (x, y), (x+w, y+h), (0, 255, 0), 2)\n+#             cv2.putText(\n+#                 frame,\n+#                 name_found,\n+#                 (x, y - 10),\n+#                 cv2.FONT_HERSHEY_SIMPLEX,\n+#                 0.9,\n+#                 (0, 255, 0),\n+#                 2\n+#             )\n+\n+#             cv2.imshow(\"Attendance System\", frame)\n+#             cv2.waitKey(1200)\n+\n+#             cap.release()\n+#             cv2.destroyAllWindows()\n+#             print(\"‚úÖ Attendance process complete. Camera closed.\")\n+#             exit()\n+\n+#         else:\n+#             cv2.rectangle(frame, (x, y), (x+w, y+h), (0, 0, 255), 2)\n+#             cv2.putText(\n+#                 frame,\n+#                 \"Unknown\",\n+#                 (x, y - 10),\n+#                 cv2.FONT_HERSHEY_SIMPLEX,\n+#                 0.9,\n+#                 (0, 0, 255),\n+#                 2\n+#             )\n+\n+#     cv2.imshow(\"Attendance System\", frame)\n+\n+# # ---------------- CLEANUP ----------------\n+# cap.release()\n+# cv2.destroyAllWindows()\n+\n+\n+\n import cv2\n import os\n import pickle\n import csv\n"
                },
                {
                    "date": 1766775471508,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -167,17 +167,21 @@\n from deepface import DeepFace\n \n from google_sheet import mark_attendance_sheet\n \n-# ---------------- CONFIG ----------------\n-EMBEDDINGS_DIR = \"embeddings\"\n-ATTENDANCE_FILE = \"attendance.csv\"\n+# ================= CONFIG =================\n+BASE_DIR = os.path.dirname(os.path.abspath(__file__))\n \n+EMBEDDINGS_DIR = os.path.join(BASE_DIR, \"embeddings\")\n+ATTENDANCE_FILE = os.path.join(BASE_DIR, \"attendance.csv\")\n+\n MODEL_NAME = \"Facenet\"\n DETECTOR = \"retinaface\"\n-THRESHOLD = 0.9   # üî• correct threshold\n \n-# ---------------- LOAD EMBEDDINGS ----------------\n+# ‚úÖ Correct metric for FaceNet\n+COSINE_THRESHOLD = 0.5   # 0.3‚Äì0.6 is realistic\n+\n+# ================= LOAD EMBEDDINGS =================\n db_embeddings = {}\n \n for file in os.listdir(EMBEDDINGS_DIR):\n     if file.endswith(\".pkl\"):\n@@ -186,9 +190,18 @@\n             db_embeddings[name] = np.array(pickle.load(f))\n \n print(\"‚úÖ Loaded users:\", list(db_embeddings.keys()))\n \n-# ---------------- ATTENDANCE ----------------\n+if len(db_embeddings) == 0:\n+    print(\"‚ùå No embeddings found. Exiting.\")\n+    exit()\n+\n+# ================= UTIL =================\n+def cosine_distance(a, b):\n+    a = a / np.linalg.norm(a)\n+    b = b / np.linalg.norm(b)\n+    return 1 - np.dot(a, b)\n+\n def already_marked(name, today):\n     if not os.path.exists(ATTENDANCE_FILE):\n         return False\n     with open(ATTENDANCE_FILE, \"r\") as f:\n@@ -216,9 +229,9 @@\n \n     mark_attendance_sheet(name, today, time_now)\n     print(f\"üü¢ Attendance marked for {name}\")\n \n-# ---------------- CAMERA ----------------\n+# ================= CAMERA =================\n cap = cv2.VideoCapture(0)\n print(\"üì∑ Camera started...\")\n \n while True:\n@@ -239,25 +252,26 @@\n         best_match = \"Unknown\"\n         min_dist = float(\"inf\")\n \n         for name, embeddings in db_embeddings.items():\n-            dists = np.linalg.norm(embeddings - live_emb, axis=1)\n-            avg_dist = np.mean(dists)\n+            dists = [cosine_distance(live_emb, emb) for emb in embeddings]\n+            avg_dist = float(np.mean(dists))\n \n             if avg_dist < min_dist:\n                 min_dist = avg_dist\n                 best_match = name\n \n-        print(f\"DEBUG ‚Üí {best_match}, distance={min_dist}\")\n+        print(f\"DEBUG ‚Üí {best_match}, cosine_dist={min_dist}\")\n \n-        if min_dist < THRESHOLD:\n+        if min_dist < COSINE_THRESHOLD:\n+            print(f\"‚úÖ Recognized: {best_match}\")\n             mark_attendance(best_match)\n-            print(\"‚úÖ Recognized:\", best_match)\n             break\n         else:\n             print(\"‚ùå Unknown face\")\n \n-    except Exception:\n+    except Exception as e:\n         print(\"‚ö†Ô∏è No face detected\")\n \n cap.release()\n cv2.destroyAllWindows()\n+print(\"‚úÖ Camera closed\")\n"
                }
            ],
            "date": 1766771017257,
            "name": "Commit-0",
            "content": "import cv2\nimport os\nimport pickle\nimport csv\nimport numpy as np\nfrom datetime import datetime\nfrom deepface import DeepFace\n\n# Google Sheet helper\nfrom google_sheet import mark_attendance_sheet\n\n# ---------------- PATHS ----------------\nEMBEDDINGS_DIR = \"embeddings\"\nATTENDANCE_FILE = \"attendance.csv\"\n\n# ---------------- LOAD EMBEDDINGS ----------------\ndb_embeddings = {}\n\nfor file in os.listdir(EMBEDDINGS_DIR):\n    if file.endswith(\".pkl\"):\n        name = file.replace(\".pkl\", \"\")\n        with open(os.path.join(EMBEDDINGS_DIR, file), \"rb\") as f:\n            db_embeddings[name] = pickle.load(f)\n\nprint(\"‚úÖ Loaded users:\", list(db_embeddings.keys()))\n\n# ---------------- ATTENDANCE FUNCTIONS ----------------\ndef already_marked(name, today):\n    if not os.path.exists(ATTENDANCE_FILE):\n        return False\n    with open(ATTENDANCE_FILE, \"r\") as f:\n        reader = csv.reader(f)\n        for row in reader:\n            if row and row[0] == name and row[1] == today:\n                return True\n    return False\n\ndef mark_attendance(name):\n    today = datetime.now().strftime(\"%Y-%m-%d\")\n    time_now = datetime.now().strftime(\"%H:%M:%S\")\n\n    # ‚úÖ CASE 1: Already marked ‚Üí only sync to Google Sheet\n    if already_marked(name, today):\n        print(f\"‚ö†Ô∏è Attendance already marked for {name}, syncing to sheet\")\n        try:\n            mark_attendance_sheet(name, today, time_now)\n            print(\"‚òÅÔ∏è Synced to Google Sheet\")\n        except Exception as e:\n            print(\"‚ùå Google Sheet error:\", e)\n        return\n\n    # ‚úÖ CASE 2: First time today ‚Üí CSV + Google Sheet\n    file_exists = os.path.exists(ATTENDANCE_FILE)\n    with open(ATTENDANCE_FILE, \"a\", newline=\"\") as f:\n        writer = csv.writer(f)\n        if not file_exists:\n            writer.writerow([\"Name\", \"Date\", \"Time\", \"Status\"])\n        writer.writerow([name, today, time_now, \"Present\"])\n\n    try:\n        mark_attendance_sheet(name, today, time_now)\n        print(f\"üü¢ Attendance marked for {name} (CSV + Sheet)\")\n    except Exception as e:\n        print(\"‚ùå Google Sheet error:\", e)\n\n# ---------------- FACE DETECTOR ----------------\nface_cascade = cv2.CascadeClassifier(\n    cv2.data.haarcascades + \"haarcascade_frontalface_default.xml\"\n)\n\n# ---------------- CAMERA ----------------\ncap = cv2.VideoCapture(0)\n\nif not cap.isOpened():\n    print(\"‚ùå Cannot access camera\")\n    exit()\n\nprint(\"üì∑ Camera started. Show your face...\")\n\nTHRESHOLD = 0.9# Facenet distance threshold\n\n# ---------------- MAIN LOOP ----------------\nwhile True:\n    ret, frame = cap.read()\n    if not ret:\n        break\n\n    gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)\n    faces = face_cascade.detectMultiScale(\n        gray, scaleFactor=1.3, minNeighbors=5, minSize=(80, 80)\n    )\n\n    for (x, y, w, h) in faces:\n        face_img = frame[y:y+h, x:x+w]\n\n        try:\n            rep = DeepFace.represent(\n                img_path=face_img,\n                model_name=\"Facenet\",\n                enforce_detection=False\n            )\n            live_embedding = np.array(rep[0][\"embedding\"])\n        except Exception:\n            continue\n\n        name_found = \"Unknown\"\n        min_dist = float(\"inf\")\n\n        for name, embeddings in db_embeddings.items():\n            for emb in embeddings:\n                dist = np.linalg.norm(live_embedding - np.array(emb))\n                if dist < min_dist:\n                    min_dist = dist\n                    name_found = name\n\n        # ---------- RECOGNITION RESULT ----------\n        if min_dist < THRESHOLD:\n            mark_attendance(name_found)\n\n            cv2.rectangle(frame, (x, y), (x+w, y+h), (0, 255, 0), 2)\n            cv2.putText(\n                frame,\n                name_found,\n                (x, y - 10),\n                cv2.FONT_HERSHEY_SIMPLEX,\n                0.9,\n                (0, 255, 0),\n                2\n            )\n\n            cv2.imshow(\"Attendance System\", frame)\n            cv2.waitKey(1200)\n\n            cap.release()\n            cv2.destroyAllWindows()\n            print(\"‚úÖ Attendance process complete. Camera closed.\")\n            exit()\n\n        else:\n            cv2.rectangle(frame, (x, y), (x+w, y+h), (0, 0, 255), 2)\n            cv2.putText(\n                frame,\n                \"Unknown\",\n                (x, y - 10),\n                cv2.FONT_HERSHEY_SIMPLEX,\n                0.9,\n                (0, 0, 255),\n                2\n            )\n\n    cv2.imshow(\"Attendance System\", frame)\n\n# ---------------- CLEANUP ----------------\ncap.release()\ncv2.destroyAllWindows()\n"
        }
    ]
}